<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="../lib/d3.min.js" type="text/javascript"></script>
    <script src="../lib/jquery-3.5.1.min.js" type="text/javascript"></script>
    <script src="../lib/lodash.js" type="text/javascript"></script>
    <style>
        body {
            margin: 0;
            border: 0;
            padding: 0;
            overflow: hidden;
        }

        #main {
            /*display: grid;*/
            /*grid-template-rows: 70% 30%;*/
            /*grid-template-columns: 100%;*/
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .container {
            border: 1px solid #777;
        }
    </style>
</head>
<body>
<div id="main"></div>
</body>
<script>
    let width = $('#main').width(),
        height = $('#main').height() * 0.3,
        margin = {left: 10, right: 10, top: 10, bottom: 30},
        clipWidth = width - margin.left - margin.right,
        clipHeight = height - margin.top - margin.bottom;

    let svg = d3.select('#main').append('svg')
        .attr('width', width)
        .attr('height', height)
        .append('g')
        .attr('transform', `translate(${margin.left}, ${margin.top})`);

    let tree_g = svg.append('g')
        .attr('class', 'tree_g');

    let xScale = d3.scaleLinear()
        .domain([485.4, 419.2])
        .range([0, clipWidth]);

    let timeXAxis = svg.append('g')
        .attr('class', 'x-axis')
        .attr('transform', `translate(0, ${clipHeight})`)
        .call(
            d3.axisBottom(xScale)
                .tickFormat(d => d + 'MA')
        )

    let clip = svg.append("defs").append("svg:clipPath")
        .attr("id", "clip")
        .append("rect")
        .attr("width", clipWidth)
        .attr("height", clipHeight)
        .attr("x", 0)
        .attr("y", 0);

    let brush = d3.brushX()
        .extent([[0, clipHeight - 10], [clipWidth, clipHeight + 10]])
        .on("end", function ({selection}) {
            if (selection) {
                console.log(selection.map(xScale.invert));
            }
        });

    svg.append("g")
        .attr("class", "brush")
        .call(brush);


    d3.csv('../data/Appendix 1. Graptolite specimens E0201.csv').then(function (data) {

    })

    d3.json('../data/tree.json').then(function (data) {
        let root = partition(data, clipWidth, clipHeight);
        console.log(data)
        const cell = tree_g
            .selectAll("g")
            .data(root.descendants())
            .join("g")
            .attr("transform", d => `translate(${d.x0},${d.y0})`);

        cell.append("rect")
            .attr("width", d => d.x1 - d.x0)
            .attr("height", d => d.y1 - d.y0)
            .attr("fill-opacity", 0.6)
            .attr("fill", d => d.data.color)
            .style('cursor', 'pointer')
            .on('click', function (event, d) {
                console.log(d.data.name);
            })

        const text = cell.append("text")
            .attr('font-size', '10px')
            .attr('font-weight', 'bold')
            .attr("x", 4)
            .attr("y", 13);

        text.append("tspan")
            .text(d => d.data.name);

        // text.append("tspan")
        //     .attr("fill-opacity", 0.7)
        //     .text(d => ` ${d.value}`);

        cell.append("title")
            .text(d => `${d.ancestors().map(d => d.data.name).reverse().join("/")}`);
    })


    function partition(data, width, height) {
        return d3.partition()
            .size([width, height])
            .padding(1)
            (d3.hierarchy(data)
                .sum(d => d.value)
                .sort((a, b) => b.height - a.height))
    }
</script>
</html>