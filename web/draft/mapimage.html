<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Add a raster image to a map layer</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
    <script src="../lib/d3.min.js" type="text/javascript"></script>
    <script src="../script/glyph.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    let radius = 80;
    let sunburstRadius = 200;

    mapboxgl.accessToken = 'pk.eyJ1IjoiaGF6YXJkdHJpZ2dlciIsImEiOiJjanl3d2d0NmQwMmNjM2NxbDhwNmVsYmkzIn0.oap8KJPjiF__xdNVrVPmvQ';
    const map = new mapboxgl.Map({
        container: 'map',
        // maxZoom: 5.99,
        minZoom: -2,
        zoom: 5,
        center: [0, 0],
        // style: 'mapbox://styles/mapbox/dark-v10'
    });

    let initbounds = map.getBounds();
    map.setMaxBounds(map.getBounds());
    let mapbox_canvas = map.getCanvasContainer();
    let mapboxSvg = d3.select(mapbox_canvas).append("svg")
        .style("position", "absolute")
        .style("z-index", "0")
        .style("width", "100%")
        .style("height", "100%");

    // https://stackoverflow.com/questions/55130943/is-there-a-way-to-disable-double-touch-zoom
    map.doubleClickZoom.disable();
    map.dragRotate.disable();

    map.addSource('radar', {
        'type': 'image',
        'url': '../images/map/Darwillian.jpg',
        'coordinates': [
            [-initbounds._ne.lng, initbounds._ne.lat],
            [initbounds._ne.lng, initbounds._ne.lat],
            [-initbounds._sw.lng, initbounds._sw.lat],
            [initbounds._sw.lng, initbounds._sw.lat]
        ]
    });
    map.addLayer({
        id: 'radar-layer',
        'type': 'raster',
        'source': 'radar',
        'paint': {
            'raster-fade-duration': 500
        }
    });

    console.log(map.getStyle().layers)

    let node_g = mapboxSvg.append('g')
        .attr('class', 'node_g');

    let glyph_g = mapboxSvg.append('g')
        .attr('class', 'glyph_g');

    let anchorCircle = glyph_g.append('g')
        .attr('class', 'anchor-circle')
        .append('circle')
        .attr('r', 80)
        .attr('fill', 'none')
        .attr('stroke', '#aaa');

    let sunburst_node_g = glyph_g.append('g')
        .attr('class', 'sunburst_node_g')
        .attr('fill-opacity', 0.9)
        .attr('stroke', '#222')
        .attr('stroke-width', 0.5);

    let sunburst_label_g = glyph_g.append('g')
        .attr('class', 'sunburst_text_g')
        .attr('text-anchor', 'middle')
        .attr('font-size', 10);

    mapboxSvg.on('mousemove', event => glyphMousemove(node_g, glyph_g, sunburst_node_g, sunburst_label_g, event, 'map'));

    d3.csv('./data/fossil8_20220123.csv', d3.autoType).then(function (data) {
        projectData(data, node_g, map);
    })

    function projectData(data, svg, map) {
        let node = svg.selectAll('.fossil')
            .data(data)
            .join(
                enter => enter.append('g')
                    .attr('class', 'fossil')
                    .style('display', 'block')
                    .attr('transform', function (d) {
                        d.x = project(d).x;
                        d.y = project(d).y;
                        return `translate(${d.x}, ${d.y})`;
                    }),
                update => update
                    .attr('class', 'fossil')
                    .style('display', 'block')
                    .attr('transform', function (d) {
                        d.x = project(d).x;
                        d.y = project(d).y;
                        return `translate(${d.x}, ${d.y})`;
                    }),
                exit => exit.remove()
            )
            .call(g => {
                g.append('circle')
                    .attr('stroke', '#777')
                    .attr("stroke-width", 2)
                    .attr('r', 8)
                    .attr('fill', d => d.color);

                g.append('text')
                    .style('font-size', 10)
                    .attr('dx', -4)
                    .attr('dy', 2)
                    .text(d => d.type);
            })

        // Update on map interaction
        map.on("pitch", updateloc);
        map.on("pitchned", updateloc);
        map.on("move", updateloc);
        map.on("moveend", updateloc);
        map.on('drag', updateloc);
        map.on('dragend', updateloc);
        map.on("zoom", updateloc);
        map.on("zoomend", updateloc);

        function updateloc() {
            svg.selectAll(".fossil")
                .attr('transform', function (d) {
                    d.x = project(d).x;
                    d.y = project(d).y;
                    return `translate(${d.x}, ${d.y})`;
                });
        }

        function project(d) {
            let bounds = map.getBounds();
            let xScale = d3.scaleLinear()
                .domain(xdomain(initbounds, bounds))
                .range([bounds._sw.lng, bounds._ne.lng]);

            let yScale = d3.scaleLinear()
                .domain(ydomain(initbounds, bounds))
                .range([bounds._sw.lat, bounds._ne.lat]);
            return map.project(new mapboxgl.LngLat(xScale(d.geoLongitude), yScale(d.geoLatitude)));
        }

        function xdomain(initbounds, currentbounds) {
            return [
                (-180 / initbounds._sw.lng) * currentbounds._sw.lng,
                (180 / initbounds._ne.lng) * currentbounds._ne.lng
            ];
        }

        function ydomain(initbounds, currentbounds) {
            return [
                (-180 / initbounds._sw.lat) * currentbounds._sw.lat,
                (180 / initbounds._ne.lat) * currentbounds._ne.lat
            ];
        }
    }
</script>

</body>
</html>